# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools

name: Deploy to Firebase Hosting on merge
'on':
  push:
    branches:
      - master
jobs:
  # deploy_firebase:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: ⬇️ Checkout repo
  #       uses: actions/checkout@v3
  #     - name: ⎔ Setup node
  #       uses: actions/setup-node@v3
  #       with:
  #         node-version: 16.18.1
  #         cache: yarn
  #     - run: yarn install
  #       env:
  #         YARN_ENABLE_IMMUTABLE_INSTALLS: false
  #     - name: 🚀 Deploy Firebase
  #       working-directory: apps/firebase
  #       run: |
  #         cd ./functions && pwd && npm install && npm run build && cd ..
  #         echo $SERVICE_ACCOUNT_BASE64 | base64 -di > $GOOGLE_APPLICATION_CREDENTIALS
  #         echo GOOGLE_APPLICATION_CREDENTIALS: $GOOGLE_APPLICATION_CREDENTIALS
  #         cat $GOOGLE_APPLICATION_CREDENTIALS | awk '{ print length }'
  #         yarn deploy || rm $GOOGLE_APPLICATION_CREDENTIALS
  #         rm $GOOGLE_APPLICATION_CREDENTIALS
  #       env:
  #         SERVICE_ACCOUNT_BASE64: '${{ secrets.SERVICE_ACCOUNT_BASE64 }}'
  #         GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/apps/firebase/service-account.json

  #  See https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/configuring-openid-connect-in-google-cloud-platform
  deploy_web:
    runs-on: ubuntu-latest
    permissions:
      id-token: write # This is required for requesting the JWT
      contents: read # This is required for actions/checkout
    steps:
      - name: ⬇️ Checkout repo
        uses: actions/checkout@v3
      - name: ⎔ Setup node
        uses: actions/setup-node@v3
        with:
          node-version: 16.18.1
          cache: yarn
      - run: yarn install
        env:
          YARN_ENABLE_IMMUTABLE_INSTALLS: false
      - run: yarn build
      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v1'
        with:
          version: '>= 417.0.0'
      - id: 'auth'
        name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v1'
        with:
          token_format: 'access_token'
          workload_identity_provider: 'projects/550579950350/locations/global/workloadIdentityPools/github/providers/github-provider-id'
          service_account: 'artifact-registry@photos-tools-2022.iam.gserviceaccount.com'
      # - name: Login to Artifact Registry
      #   run: |
      #     gcloud auth login --brief --cred-file="${{ steps.auth.outputs.credentials_file_path }}"
      #     gcloud services list

      # - name: Checkout actions-oidc-debugger
      #   uses: actions/checkout@v3
      #   with:
      #     repository: github/actions-oidc-debugger
      #     ref: main
      #     token: ${{ steps.auth.outputs.access_token }}
      #     path: ./.github/actions/actions-oidc-debugger
      # - name: Debug OIDC Claims
      #   uses: ./.github/actions/actions-oidc-debugger
      #   with:
      #     audience: 'https://github.com/github'

      - name: 🚀 Deploy Web (Docker)
        run: |
          ls -al
          sh bin/docker/deploy.sh
        env:
          ACTIONS_STEP_DEBUG: true
