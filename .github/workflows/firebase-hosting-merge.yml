name: Deploy to Firebase Hosting on merge
'on':
  push:
    branches:
      - master
jobs:
  deploy_firebase:
    runs-on: ubuntu-latest
    steps:
      - name: ⬇️ Checkout repo
        uses: actions/checkout@v3
      - name: ⎔ Setup node
        uses: actions/setup-node@v3
        with:
          node-version: 16.18.1
          cache: yarn
      - run: yarn install
        env:
          YARN_ENABLE_IMMUTABLE_INSTALLS: false
      - name: 🚀 Deploy Firebase
        working-directory: apps/firebase
        run: |
          cd ./functions && pwd && npm install && npm run build && cd ..
          echo $SERVICE_ACCOUNT_BASE64 | base64 -di > $GOOGLE_APPLICATION_CREDENTIALS
          yarn deploy || rm $GOOGLE_APPLICATION_CREDENTIALS
          rm $GOOGLE_APPLICATION_CREDENTIALS
        env:
          SERVICE_ACCOUNT_BASE64: ${{ secrets.SERVICE_ACCOUNT_BASE64 }}
          GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/apps/firebase/service-account.json

  deploy_web:
    runs-on: ubuntu-latest
    # needs: deploy_firebase
    permissions:
      id-token: write # This is required for requesting the JWT
      contents: read # This is required for actions/checkout
    steps:
      - name: ⬇️ Checkout repo
        uses: actions/checkout@v3
      - name: ⎔ Setup node
        uses: actions/setup-node@v3
        with:
          node-version: 16.18.1
          cache: yarn
      - run: yarn install
        env:
          YARN_ENABLE_IMMUTABLE_INSTALLS: false
      - run: yarn build

      # https://github.com/jonfriesen/windows-signer-action
      - name: Sign Windows x64 binary
        uses: jonfriesen/windows-signer-action@v1.0.0
        env:
          NAME: "Chris Esplin"
          DOMAIN: https://photos.chrisesplin.com
          BINARY: apps/web/public/daemon/quiver-photos-windows-x64/daemon-win-x64.exe
          WINDOWS_CERT: ${{ secrets.WINDOWS_CERT }}
          WINDOWS_KEY: ${{ secrets.WINDOWS_KEY }}
      - name: Sign Windows arm64 binary
        uses: jonfriesen/windows-signer-action@v1.0.0
        env:
          NAME: "Chris Esplin"
          DOMAIN: https://chrisesplin.com
          BINARY: apps/web/public/daemon/quiver-photos-windows-arm64/daemon-win-arm64.exe
          WINDOWS_CERT: ${{ secrets.WINDOWS_CERT }}
          WINDOWS_KEY: ${{ secrets.WINDOWS_KEY }}

      #  See https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/configuring-openid-connect-in-google-cloud-platform
      #
      # Also see notes/artifact-registry.md
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
        with:
          version: '>= 417.0.0'
      - id: auth
        name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          token_format: access_token
          workload_identity_provider: projects/550579950350/locations/global/workloadIdentityPools/github/providers/github-provider-id
          service_account: artifact-registry@photos-tools-2022.iam.gserviceaccount.com

      - name: 🚀 Deploy Web (Docker)
        run: sh bin/docker/deploy.sh
        env:
          GOOGLE_AUTH_CLIENT_ID: ${{ secrets.GOOGLE_AUTH_CLIENT_ID }}
          GOOGLE_AUTH_CLIENT_SECRET: ${{ secrets.GOOGLE_AUTH_CLIENT_SECRET }}
